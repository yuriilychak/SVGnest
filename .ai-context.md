# SVGnest Project Context

## Project Overview

**SVGnest** is a TypeScript/Rust hybrid browser-based vector nesting tool for optimizing polygon packing. It's a modernized and
performance-enhanced fork of the original SVGnest, restructured as a monorepo with significant architectural improvements.

### Key Features & Improvements

-   **Monorepo Structure**: Uses Lerna for managing multiple packages
-   **TypeScript Migration**: Converted from JavaScript to TypeScript for better type safety
-   **WebAssembly Integration**: Critical performance sections migrated to Rust/WASM (10x speed improvement)
-   **Memory Optimization**: Migrated from Float64 to Float32/Int32 for better performance
-   **Worker Optimization**: Workers are created once and reused with ArrayBuffer I/O
-   **Modern React UI**: User interface built with React and modern tooling
-   **Isolated Dependencies**: Custom js-clipper implementation to reduce bundle size

## Architecture

### Package Structure

```
packages/
├── geometry-utils/     # Core geometry calculations and clipper logic
├── polygon-packer/     # Main packing algorithm with genetic optimization
├── svg-parser/         # SVG parsing and shape building
├── svg-node-parser/    # Node.js SVG parsing utilities
├── wasm-nesting/       # Rust/WebAssembly performance-critical code
└── web-interface/      # React-based user interface
```

### Technology Stack

-   **Frontend**: React 18, TypeScript, SCSS, i18next
-   **Build Tools**: Webpack 5, Lerna 8, Babel
-   **Backend/Performance**: Rust, WebAssembly (wasm-bindgen)
-   **Development**: ESLint, Prettier, Jest (testing framework ready)

## Package Details

### 1. geometry-utils

**Purpose**: Core geometry calculations and clipper operations

-   **Main Exports**: ClipperWrapper, PolygonF32, calculate (worker-flow)
-   **Dependencies**: wasm-nesting (workspace)
-   **Key Features**:
    -   Custom clipper implementation (data locality pattern)
    -   Float32 geometry operations
    -   Worker flow management
    -   NFP (No Fit Polygon) calculations

### 2. wasm-nesting

**Purpose**: High-performance Rust/WASM module for critical calculations

-   **Language**: Rust with wasm-bindgen
-   **Key Functions**:
    -   polygon_area calculation
    -   almost_equal comparisons
    -   Bit manipulation operations
    -   Pair flow optimizations (10x performance boost)

### 3. polygon-packer

**Purpose**: Main packing algorithm with genetic optimization

-   **Features**:
    -   Genetic algorithm implementation
    -   Phenotype management
    -   Parallel processing support
    -   NFP store management

### 4. svg-parser

**Purpose**: SVG parsing and shape building

-   **Features**:
    -   Non-DOM SVG parsing
    -   Path building and transformation
    -   Shape builders for various SVG elements
    -   Matrix transformations

### 5. web-interface

**Purpose**: React-based user interface

-   **Dependencies**: polygon-packer, svg-parser
-   **Features**:
    -   Modern React 18 with hooks
    -   Internationalization (i18next)
    -   Responsive design
    -   Demo mode support

## Build System

### Scripts (Root Level)

-   `npm run build`: Build all packages via Lerna
-   `npm run watch`: Watch mode for all packages in parallel
-   `npm run test`: Run tests across all packages
-   `npm run lint`: Lint all packages
-   `npm run lint:fix`: Auto-fix linting issues

### Package-Level Scripts

Each package supports:

-   `build`: Webpack build for distribution
-   `watch`: Development watch mode
-   `test`: Jest testing
-   `lint`/`lint:fix`: ESLint operations

### Build Output

All packages build to `/dist` directory:

-   `geometry-utils.js`
-   `polygon-packer.js`
-   `svg-parser.js`
-   `wasm-nesting.js`
-   `web-interface.js`

## Development Workflow

### WASM Development

1. Rust code in `packages/wasm-nesting/src/`
2. Build with `node scripts/wasm-build.js`
3. Output to `pkg/` directory
4. Bundled with webpack

### TypeScript Development

-   All packages use TypeScript with shared tsconfig
-   ES6 modules with UMD build output
-   Source maps enabled for debugging

### Styling

-   SCSS with modern CSS features
-   Shared styles in `@shared-styles.scss`
-   Component-level styling

## Key Algorithms

### Nesting Algorithm

1. **NFP Generation**: No Fit Polygon calculations for collision detection
2. **Genetic Algorithm**: Optimization using phenotype evolution
3. **Pair Flow**: Critical performance section implemented in Rust
4. **Worker Management**: Parallel processing with reusable workers

### Performance Optimizations

-   **WASM Integration**: 10x speed improvement for pair flow
-   **Memory Layout**: Data locality patterns for better cache performance
-   **Typed Arrays**: Float32Array for geometry operations
-   **Worker Pools**: Persistent workers to avoid creation overhead

## File Structure Patterns

### Source Code Organization

```
src/
├── index.ts              # Main entry point
├── types.ts             # TypeScript type definitions
├── constants.ts         # Configuration constants
├── helpers.ts           # Utility functions
└── [feature-folders]/  # Feature-specific modules
```

### Configuration Files

-   `package.json`: npm configuration and dependencies
-   `tsconfig.json`: TypeScript compilation settings
-   `webpack.config.mjs`: ES module webpack configuration
-   `Cargo.toml`: Rust package configuration (wasm-nesting only)

## Development Guidelines

### Code Style

-   TypeScript strict mode enabled
-   ESLint with Prettier integration
-   React functional components with hooks
-   Rust with standard formatting

### Testing

-   Jest framework configured
-   Test files co-located with source
-   Ready for unit and integration tests

### Dependencies

-   Workspace dependencies using `workspace:*`
-   External dependencies minimized
-   Custom implementations preferred for core functionality

## Common Development Tasks

### Adding New Geometry Operations

1. Implement in TypeScript in `geometry-utils`
2. Consider Rust implementation for performance-critical paths
3. Add to worker flow if needed for parallel processing

### UI Enhancements

1. Modify React components in `web-interface/src`
2. Update i18n files for internationalization
3. Add shared styles as needed

### Performance Optimization

1. Profile JavaScript performance
2. Identify bottlenecks for Rust migration
3. Optimize worker data serialization

### SVG Feature Support

1. Add shape builders in `svg-parser`
2. Update format-svg transformations
3. Test with various SVG inputs

## Deployment

### Production Build

-   All packages build to UMD modules in `/dist`
-   Index.html loads scripts in dependency order
-   WASM module loaded first for initialization

### Browser Compatibility

-   ES6+ features used
-   WebWorker support required
-   WebAssembly support required
-   Modern browser recommended for full performance

## Future Roadmap (TODOs)

1. **Node.js Package**: Server-side nesting tool
2. **Documentation**: ES-doc for all files
3. **Full WASM Migration**: More geometry calculations to Rust
4. **SIMD Optimization**: Advanced performance optimizations
5. **Testing**: Comprehensive test coverage

This context should help agents understand the project structure, make appropriate modifications, and maintain consistency with
the existing architecture and patterns.
